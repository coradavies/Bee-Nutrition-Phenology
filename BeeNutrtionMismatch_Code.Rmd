---
title: "Mismatch of Bees & Nutrition"
author: "Cora Davies"
date: "01/02/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggpubr)
library(dplyr)
library(hrbrthemes)
library(vegan)
library(corrplot)
library(RColorBrewer)
library(bipartite)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(rstatix)
library(nplr)
library(ggtern)
library(bipartite)
library(rcompanion)
```

###DATA ANALYSIS    

This R markdown document contains the analyses conducted for _Temporal overlap of native bee assemblages with pollen protein density in forest canopy gaps is mediated by bee body size_ (Davies & Davis, 2022).

## Calculate Bradford Standard Curves

First calculate the Standard curves:

```{r}
###Create model

#import data
Standard1 <-read.csv("Bradford/StandardCurve1.csv") #Contains concentration (ug/ml) and readings

Standard2 <-read.csv("Bradford/StandardCurve2.csv") #Contains concentration (ug/ml) and readings

Standard3 <-read.csv("Bradford/StandardCurve3.csv") #Contains concentration (ug/ml) and readings

#model (second order polynomial) 
model1 = lm(Reading~poly(Concentration,2, raw=TRUE), data = Standard1)
summary(model1)

model2 = lm(Reading~poly(Concentration,2, raw=TRUE), data = Standard2)
summary(model2)

model3 = lm(Reading~poly(Concentration,2, raw=TRUE), data = Standard3)
summary(model3)

#Visualize

ggplot(Standard1, aes(x = Concentration, y = Reading)) + geom_point() + stat_smooth(method = "lm", formula = y ~ poly(x, 2), size = 1)

ggplot(Standard2, aes(x = Concentration, y = Reading)) + geom_point() + stat_smooth(method = "lm", formula = y ~ poly(x, 2), size = 1)

ggplot(Standard3, aes(x = Concentration, y = Reading)) + geom_point() + stat_smooth(method = "lm", formula = y ~ poly(x, 2), size = 1)

```


## Predict protein concentration for samples

First we have to create a quadratic formula so we can solve for x (Concentration) at the given readings. 
```{r}
## Quadratic formula:

# Quadratic Formula In R:

# Adapted from: http://stackoverflow.com/questions/15589601/print-string-and-variable-contents-on-the-same-line-in-r

# Quadratic equation form of ax^2 + bx + c

# Written to only return the positive root 

quadraticRoots <- function(a, b, c) {

  discriminant <- (b^2) - (4*a*c)

  if(discriminant < 0) {
    return(paste0("This quadratic equation has no real numbered roots."))
  }
  else if(discriminant > 0) {
    x_int_plus <- (-b + sqrt(discriminant)) / (2*a)

    return(paste0(format(round(x_int_plus, 5), nsmall = 5)))
  }
  else #discriminant = 0  case
    x_int <- (-b) / (2*a)
    return(paste0(x_int))
}

```

Once we have an equation to return the x values at given y values then we can solve for the unknown concentrations. 

```{r, warning=FALSE}

#import data with readings from pollen samples
Bradford1 <-read.csv("Bradford/BradfordAssay1.csv")

Bradford2 <-read.csv("Bradford/BradfordAssay2.csv")

Bradford3 <-read.csv("Bradford/BradfordAssay3.csv")

#solve for x=concentration for the readings using the equation generated from the linear model

#Model 1: (a=-0.00007536, b=0.007403, c=0.1144)
#Model 2: (a=-0.00006279, b=0.006819, c=0.1182)
#Model 3: (a=-0.00005061, b=0.006136, c=0.1304)

# Adding column based on other column:
#adds new column with the concentrations
Bradford1 <- Bradford1 %>%
  mutate(Concentration = 
           quadraticRoots(-0.00007536, 0.007403, (0.1144-Reading)))

Bradford2 <- Bradford2 %>%
  mutate(Concentration = 
           quadraticRoots(-0.00006279, 0.006819, (0.1182-Reading)))

Bradford3 <- Bradford3 %>%
  mutate(Concentration = 
           quadraticRoots(-0.00005061, 0.006136, (0.1304-Reading)))
```
Finally we create a new data frame and save it as a csv so that it can be used in other analyses:

```{r}
#join the data using dplyr 
    FloralProtein<- bind_rows(Bradford1, Bradford2, Bradford3)

#Fix the concentration values that don't make sense. 
  #Use a linear model of the NaN = >50
model2_linear = lm(Reading~Concentration, data = Standard2)
model3_linear = lm(Reading~Concentration, data = Standard3)

  #assign new values
FloralProtein[131, 10] = ((0.455-0.1302541)/0.0037969)
FloralProtein[132, 10] = ((0.355-0.1302541)/0.0037969)
FloralProtein[159, 10] = ((0.321-0.1400846)/0.0037001)
  
  #Negative number = Not detectable (0)
FloralProtein[154, 10] = 0
FloralProtein[155, 10] = 0
FloralProtein[174, 10] = 0
FloralProtein[199, 10] = 0
FloralProtein[202, 10] = 0

#Add row to for the pollen mass per flower (FlowerMass)
FloralProtein <- FloralProtein %>%
  mutate(FlowerMass = (Mass/Count))

#Add row to for the protein content per flower (FlowerProtein)
#make sure data is numeric 
FloralProtein <- transform(FloralProtein,
                             Concentration = as.numeric(Concentration))
Protein_all <- FloralProtein %>%
  mutate(FlowerProtein = (FlowerMass*Concentration))

##create data with mean values only

#Calculate means
FloralProtein_Means <- Protein_all %>% select(c(Species,Mass,Concentration,Count,FlowerMass,FlowerProtein))

FloralProtein_Means<- FloralProtein_Means %>% group_by(Species) %>%
       mutate(Mass_Mean = mean(Mass)) %>%
       mutate(Concentration_Mean=mean(Concentration)) %>%
       mutate(Count_Mean=mean(Count)) %>%
       mutate(FlowerMass_Mean=mean(FlowerMass)) %>%
       mutate(FlowerProtein_Mean=mean(FlowerProtein))

#select only desired columns
FloralProtein_Means<- FloralProtein_Means %>% select(c(Species,Mass_Mean,Concentration_Mean,Count_Mean,FlowerMass_Mean,FlowerProtein_Mean))

#remove duplicates (so there is only one row per species)
Protein <- FloralProtein_Means %>% 
  distinct()

```


## Data analyses 

a) Phenology of floral availability, pollen protein, and bee-flower interactions

```{r}
#Import data

Abundance <- read.csv("FloralAbundance.csv")
Abundance$Site<-as.factor(Abundance$Site)

FloralTraits <- read.csv("FloralMeasurements.csv")

SiteInfo <- read.csv("SiteInformation.csv")
SiteInfo$Site<-as.factor(SiteInfo$Site) #site as factor
SiteInfo <- SiteInfo %>% select(Site, Size) #only need site number and size

Bees <- read.csv("BeeCaptures.csv")
Bees$Site<-as.factor(Bees$Site) #site as factor

BeeTraits <- read.csv("GenusTraits.csv")

#add bee traits to bees

Bees<-left_join(Bees, BeeTraits, by="Genus")

#color blind friendly color palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

```

## Phenology and patch size
The first objective is to analyze flower and bee phenology over a patch size gradient. 

# Floral phenology

FigS2a Phenology of floral density relative to patch size

```{r}
#Calculate summary data for floral abundance (average count/m^2) for each species at each sampling interval 

AbunSum <- Abundance %>% group_by(Site, Day, Species) %>% 
  summarize(Count = sum(Count))

AbunSum <- AbunSum %>%
  mutate(Density=Count/75)

AbunSum2 <- left_join(AbunSum, SiteInfo, by="Site")

#summarized (across all species)

AbunSum2 <- AbunSum2 %>% 
  group_by(Site, Day, Size) %>% 
  summarize(Abundance = sum(Count),
            Density=sum(Density))

#plot the data 

S1a<- AbunSum2 %>%
  ggplot(aes(x=Day, y=Density)) +
      geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab(expression(Floral~Density~(flowers/m^2))) +
  xlab("Day of Year") +
  theme_classic()

m1<- lm(Density~ Day * Size, data=AbunSum2)
anova(m1)

m1_2<- lmer(Density~ Day * Size + (1|Site), data=AbunSum2)
anova(m1_2)


S2a<- ggscatter(AbunSum2,x="Size",y="Density",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab(expression(Floral~density~(count/m^2)))+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())

```

FigS2b Phenology of floral richness relative to patch size
FigS2c Phenology of floral diversity relative to patch size

```{r}

#calculate floral richness
Floralrich<-subset(Abundance, Species != "None") 
Floralrich<- Floralrich %>% group_by(Site, Day) %>%
  summarize(Richness = length(unique(Species)))
Floralrich2 <- left_join(Floralrich, SiteInfo, by=c("Site")) #add site size

#Calculate floral diversity
floralspecies<-subset(Abundance, Species != "None") 

floralspecies<- floralspecies %>% group_by(Site, Day, Species) %>% summarize(Abundance = sum(Count))

Floralmatrix <- floralspecies %>%
  spread(key = Species, value = Abundance)

Floralmatrix<- Floralmatrix %>%
  mutate_all(funs(ifelse(is.na(.), 0, .)))#change NA cells to 0

diversity <- left_join(Floralmatrix, SiteInfo, by=c("Site")) #add site size

#Calculate and add diversity to the existing ‘diversity’ data frame
diversity$Shannon=vegan::diversity(diversity[c(3:85)], index="shannon")

#plot the data 

S1b<- Floralrich2 %>%
  ggplot( aes(x=Day, y=Richness)) +
      geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab("Floral Species Richness") +
  xlab("Day of Year") +
  theme_classic()

m2<- lm(Richness~ Day * Size, data=Floralrich2)
anova(m2)

m2_2<- lmer(Richness~ Day * Size + (1|Site), data=Floralrich2)
anova(m2_2)

S2b<- ggscatter(Floralrich2,x="Size",y="Richness",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab(expression(Floral~richness))+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())


S1c<- diversity %>%
  ggplot( aes(x=Day, y=Shannon)) +
geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab("Floral Diversity (Shannon H')") +
  xlab("Day of Year") +
  theme_classic()

m3<- lm(Shannon~ Day * Size, data=diversity)
anova(m3)

m3_2<- lmer(Shannon~ Day * Size + (1|Site), data=diversity)
anova(m3_2)

S2c<- ggscatter(diversity,x="Size",y="Shannon",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Floral diversity (Shannon H')")+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())

```

FigS2d Phenology of protein density relative to patch size

```{r}

#calculate protein density

#Floral protein data with only Species and FlowerProtein_Mean (ug protein/flower)
Protein2<- Protein %>% 
  select(c("Species", "FlowerProtein_Mean"))

#make list of data
data_list <- list(AbunSum, Protein2)     
#merge data
MeadowProtein<-data_list %>% reduce(inner_join, by = "Species")  

MeadowProtein <- left_join(MeadowProtein, SiteInfo, by=c("Site")) #add site size

#Calculate protein content density at each meadow 

#protein density per floral species
MeadowProtein <- MeadowProtein %>% 
  group_by(Site, Day, Species, Size) %>% 
  summarize(ProteinDensity = Density*FlowerProtein_Mean)

#summarized (total protein density-sum across all species)

MeadowProtein <- MeadowProtein %>% 
  group_by(Site, Day, Size) %>% 
  summarize(ProteinDensitySum = sum(ProteinDensity),
            ProteinDensitySum2 = log(sum(ProteinDensity)))

#plot the data 

S1d<- MeadowProtein %>%
  ggplot( aes(x=Day, y=ProteinDensitySum2)) +
 geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab(expression(Log~site~protein~density~(ug/m^2))) +
  xlab("Day of Year") +
  theme_classic()

m4<- lm(ProteinDensitySum2~ Day * Size, data=MeadowProtein)
anova(m4)

m4_2<- lmer(ProteinDensitySum2~ Day * Size + (1|Site), data=MeadowProtein)
anova(m4_2)

S2d<- ggscatter(MeadowProtein,x="Size",y="ProteinDensitySum2",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab(expression(Log~site~protein~density~(ug/m^2)))+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())

#combine all into one figure 

S1<- ggarrange(S1a, S1b, S1c, S1d,
                    labels = "auto",
                    ncol = 2, nrow = 2, common.legend=TRUE,legend="bottom")

ggsave("S1_800.tiff", width = 8, height = 8, device='tiff', dpi=800)

S2<- ggarrange(S2a, S2b, S2c, S2d,
                    labels = "auto",
                    ncol = 2, nrow = 2, common.legend=TRUE,legend="bottom")

ggsave("S2_800.tiff", width = 8, height = 8, device='tiff', dpi=800)

```

# Bee phenology

FigS4a Phenology of bee abundance relative to patch size

```{r}
#Calculate summary data for bee abundance (average count/m^2) for each species at each sampling interval 

#add number for interactions and none as 0
Bees2 <- Bees %>% 
  mutate(Count = if_else(Flower==Bee, 0, 1))
  
#calculate abundance
Beeab <- Bees2 %>% group_by(Site, Day) %>% 
  summarise(Abundance = sum(Count))

Beeab2 <- left_join(Beeab, SiteInfo, by="Site")

#plot the data 

S3a<- Beeab2 %>%
  ggplot(aes(x=Day, y=Abundance)) +
 geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab("Bee Abundance") +
  xlab("Day of Year") +
  theme_classic()

m5<- lm(Abundance~ Day * Size, data=Beeab2)
anova(m5)

m5_2<- lmer(Abundance~ Day * Size + (1|Site), data=Beeab2)
anova(m5_2)

S4a<- ggscatter(Beeab2,x="Size",y="Abundance",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Bee-flower interactions")+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())

```

Phenology of bee richness relative to patch size

```{r}
#Table S1: summarize bee genera abundances across meadows
Bees3<- Bees %>% filter(Bee != "None") #remove none
tables1<- Bees3 %>% group_by(Site, Family, Bee) %>%
  summarize(Count = n()) %>%
  spread(key = Site, value = Count) %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) #change NA cells to 0

#calculate bee richness
Beerich <- Bees3 %>% group_by(Site, Day) %>%
  summarize(Richness = length(unique(Bee)))
Beerich <- left_join(Beerich, SiteInfo, by=c("Site")) #add site size
Beerich <- Beerich %>% as.data.frame() %>%
  add_row(Site = c('5', '7', '8'), Day = c(255, 255, 255), Richness = c(0,0,0), Size = c(0.83, 0.45, 0.16)) #add zeros

S3b<- Beerich %>%
  ggplot(aes(x=Day, y=Richness)) +
 geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab("Bee Species Richness") +
  xlab("Day of Year") +
  theme_classic()

m6<- lm(Richness~ Day * Size, data=Beerich)
anova(m6)

m6_2<- lmer(Richness~ Day * Size + (1|Site), data=Beerich)
anova(m6_2)

S4b<- ggscatter(Beerich,x="Size",y="Richness",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Bee richness")+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())

```

Phenology of bee diversity relative to patch size

```{r}

##Calculate bee diversity
#create matrix by site-day
Beediversity<- Bees3 %>% group_by(Site, Day, Bee) %>%
  summarize(Count = n()) %>%
  spread(key = Bee, value = Count) %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) #change NA cells to 0
Beediversity <- left_join(Beediversity, SiteInfo, by=c("Site")) #add site size

#Calculate and add diversity to the existing ‘Beediversity’ data frame
Beediversity$Shannon=vegan::diversity(Beediversity[c(3:43)], index="shannon")
Beediversity <- Beediversity %>% as.data.frame() %>%
  add_row(Site = c('5', '7', '8'), Day = c(255, 255, 255), Shannon = c(0,0,0), Size = c(0.83, 0.45, 0.16)) #add zeros

#plot the data 
S3c<- Beediversity %>%
  ggplot( aes(x=Day, y=Shannon)) +
 geom_line(aes(group=Site), colour="grey40", alpha=.25) +
  geom_smooth(colour="black") +
  ylab("Bee Diversity (Shannon H')") +
  xlab("Day of Year") +
  theme_classic()

m7<- lm(Shannon~ Day * Size, data=Beediversity)
anova(m7)

m7_2<- lmer(Shannon~ Day * Size + (1|Site), data=Beediversity)
anova(m7_2)

S4c<- ggscatter(Beediversity,x="Size",y="Shannon",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Bee diversity (Shannon H')")+
  xlab("Canopy gap size (ha)")+
  theme(legend.title = element_blank())

#combine all into one figure 

S3<- ggarrange(S3a, S3b, S3c,
                    labels = "auto",
                    ncol = 2, nrow = 2, common.legend=TRUE,legend="bottom")

ggsave("S3_800.tiff", width = 8, height = 8, device='tiff', dpi=800)

S4<- ggarrange(S4a, S4b, S4c,
                    labels = "auto",
                    ncol = 2, nrow = 2, common.legend=TRUE,legend="bottom")

ggsave("S4_800.tiff", width = 8, height = 8, device='tiff', dpi=800)


```

#Chi-square test for body size vs. time and meadow size

```{r, warning=F}
#BEE BODY SIZE 
#bee size versus time (sample period)
beesize_time <- Bees3 %>% 
  group_by(Sample, BodySize) %>% 
  summarize(IntTotal = length(unique(ID)))

beesize_time$Date <- c(141, 141, 141, 
                       154, 154, 154, 
                       169, 169, 169,
                       182, 182, 182,
                       195, 195, 195,
                       209, 209, 209,
                       223, 223, 223,
                       233, 233, 233,
                       255, 255, 255)

#visualize
fig3a<- ggplot(beesize_time, aes(x =as.factor(Date), y = IntTotal, fill = BodySize)) + 
  geom_histogram(stat = "identity", position = "fill") +
  xlab("Sample date") +
  ylab("Percent abundance (%)") +
  scale_fill_manual(values=cbPalette)+
  theme_classic()

#test
beesize_time <- beesize_time %>%
  spread(key = BodySize, value = IntTotal)

beesize_time$Sample <- as.factor(beesize_time$Sample)
beesize_time[is.na(beesize_time)] <- 0

chisq.test(beesize_time[3:5])

    
#bee body size versus meadow size
beesize_meadowsize <- Bees3 %>% 
  group_by(Site, BodySize) %>% 
  summarize(IntTotal = length(unique(ID)))

beesize_meadowsize <- left_join(beesize_meadowsize, SiteInfo, by="Site")

#visualize
fig3b<- ggplot(beesize_meadowsize, aes(x = as.factor(Size), y = IntTotal, fill = BodySize)) + 
  geom_histogram(stat = "identity", position = "fill") +
  xlab("Canopy gap size (ha)") +
  ylab("Percent abundance (%)") +
  scale_fill_manual(values=cbPalette)+
  theme_classic()

#Test
beesize_meadowsize <- beesize_meadowsize %>%
  spread(key = BodySize, value = IntTotal)

chisq.test(beesize_meadowsize[3:5])

```

#Chi-square test for sociality vs. time and meadow size

```{r, warning=F}
#BEE SOCIALITY
#bee sociality versus time (sample period)
beesoc_time <- Bees3 %>% 
  group_by(Sample, Sociality) %>% 
  summarize(IntTotal = length(unique(ID)))


beesoc_time$Date <- c(141, 141, 141, 141, 
                       154, 154, 154, 154,
                       169, 169, 169, 169,
                       182, 182, 182,
                       195, 195, 195, 195,
                       209, 209, 209, 209,
                       223, 223, 223, 223,
                       233, 233, 233,
                       255, 255, 255, 255)

#visualize
fig3c<- ggplot(beesoc_time, aes(x = as.factor(Date), y = IntTotal, fill = Sociality)) + 
  geom_histogram(stat = "identity", position = "fill") +
  xlab("Sample date") +
  ylab("Percent abundance (%)") +
  scale_fill_manual(values=cbPalette)+
  theme_classic()

#test
beesoc_time <- beesoc_time %>%
  spread(key = Sociality, value = IntTotal)

beesoc_time$Sample <- as.factor(beesoc_time$Sample)
beesoc_time[is.na(beesoc_time)] <- 0

chisq.test(beesoc_time[3:6])

    
#bee body size versus meadow size
beesoc_meadowsize <- Bees3 %>% 
  group_by(Site, Sociality) %>% 
  summarize(IntTotal = length(unique(ID)))

beesoc_meadowsize <- left_join(beesoc_meadowsize, SiteInfo, by="Site")

#visualize
fig3d<- ggplot(beesoc_meadowsize, aes(x = as.factor(Size), y = IntTotal, fill = Sociality)) + 
  geom_histogram(stat = "identity", position = "fill") +
  xlab("Canopy gap size (ha)") +
  ylab("Percent abundance (%)") +
  scale_fill_manual(values=cbPalette)+
  theme_classic()

#Test
beesoc_meadowsize <- beesoc_meadowsize %>%
  spread(key = Sociality, value = IntTotal)
beesoc_meadowsize[is.na(beesoc_meadowsize)] <- 0

chisq.test(beesoc_meadowsize[3:6])

```

#Chi-square test for nesting vs. time and meadow size

```{r, warning=F}
#BEE NESTING
#bee nesting versus time (sample period)
beenest_time <- Bees3 %>% 
  group_by(Sample, Nest1) %>% 
  summarize(IntTotal = length(unique(ID)))

beenest_time$Date <- c(141, 141, 141,  
                       154, 154, 154, 154,
                       169, 169, 169, 169,
                       182, 182, 182,
                       195, 195, 195, 195,
                       209, 209, 209, 209,
                       223, 223, 223, 223,
                       233, 233,
                       255, 255, 255, 255)

#visualize
fig3e<- ggplot(beenest_time, aes(x = as.factor(Date), y = IntTotal, fill = factor(Nest1, levels=c("klepto", "above", "below", "both")))) + 
  geom_histogram(stat = "identity", position = "fill") +
  labs(fill = "Nesting") +
  xlab("Sample date") +
  ylab("Percent abundance (%)") +
  scale_fill_manual(values=cbPalette)+
  guides(color = guide_legend(title = "Nesting behavior"))+ 
  theme_classic()

#test
beenest_time <- beenest_time %>%
  spread(key = Nest1, value = IntTotal)

beenest_time$Sample <- as.factor(beenest_time$Sample)
beenest_time[is.na(beenest_time)] <- 0

chisq.test(beenest_time[3:6])

    
#bee body size versus meadow size
beenest_meadowsize <- Bees3 %>% 
  group_by(Site, Nest1) %>% 
  summarize(IntTotal = length(unique(ID)))

beenest_meadowsize <- left_join(beenest_meadowsize, SiteInfo, by="Site")

#visualize
fig3f<- ggplot(beenest_meadowsize, aes(x = as.factor(Size), y = IntTotal, fill = factor(Nest1, levels=c("klepto", "above", "below", "both")))) + 
  geom_histogram(stat = "identity", position = "fill") +
  labs(fill = "Nesting") +
  xlab("Canopy gap size (ha)") +
  ylab("Percent abundance (%)") +
  scale_fill_manual(values=cbPalette)+
  theme_classic()

#Test
beenest_meadowsize <- beenest_meadowsize %>%
  spread(key = Nest1, value = IntTotal)
beenest_meadowsize[is.na(beenest_meadowsize)] <- 0

chisq.test(beenest_meadowsize[3:6])

```



Create figure 3. 

```{r}
#Combine all figures 
fig3_1<- ggarrange(fig3a, fig3b,
                    labels = "auto",
                    ncol = 2, nrow = 1, common.legend=TRUE,legend="right")
fig3_2<- ggarrange(fig3c, fig3d,
                    labels = c("c", "d"),
                    ncol = 2, nrow = 1, common.legend=TRUE,legend="right")
fig3_3<- ggarrange(fig3e, fig3f,
                    labels = c("e", "f"),
                    ncol = 2, nrow = 1, common.legend=TRUE,legend="right")


figure3<- ggarrange(fig3_1, fig3_2, fig3_3,
                    ncol = 1, nrow = 3)

ggsave("Fig3_800.tiff", width = 12, height = 14, device='tiff', dpi=800)

```

### Bee-Flower Interactions

Create a table for list of plant species and their nutritional values (with columns also for total interactions and unique interactions).

```{r}

# concentration of protein in each species
nutrition <- Protein_all %>% select(c("Species", "Concentration"))
nutrition <- nutrition %>% rename(Flower=Species)
nutrition <- nutrition %>% group_by(Flower) %>%
  summarize(n = n(),
            concentration = mean(Concentration),
            sd = sd(Concentration),
            se=sd/sqrt(n))


# calculate interactions 
flowerI <- Bees3 %>% group_by(Flower, Bee) %>% summarize(IntTotal = length(unique(ID)))

flowerI <- flowerI %>% group_by(Flower) %>% summarize(IntTotal = sum(IntTotal), IntRich = n())

#merge data frames
table1<- merge(x = nutrition, y = flowerI, all = TRUE)

```
#Pollinator importance index
Formula to normalize data between 0 and 1 :
Transformed.Values=Values−Minimum/Maximum−Minimum

```{r}
#normalize data 
  #select only columns of interest
index<- table1 %>%
  select(c(Flower, concentration, IntTotal, IntRich))
  #remove species where protein concentration was not measured
index <- index[!is.na(index$concentration),]
  #replace NA values in interactions with 0
index[is.na(index)] <- 0
  #normalize
Sum<- index %>%  
  summarize( min1 = min(concentration),
             min2 = min(IntTotal),
             min3 = min(IntRich),
             max1 = max(concentration),
             max2 =max(IntTotal),
             max3 =max(IntRich))

index_norm <- transform(index, concentration = (concentration-Sum$min1)/(Sum$max1-Sum$min1),
                          IntTotal = (IntTotal-Sum$min2)/(Sum$max2-Sum$min2),
                          IntRich = (IntRich-Sum$min3)/(Sum$max3-Sum$min3))

#multiply protein, IntTotal, and IntRich
index_norm <- index_norm %>% 
  mutate(index=concentration*IntTotal*IntRich)

#add native/invasive status to df
status<- FloralTraits %>% rename(Flower=Species)
status<- status %>% select(Flower, Status)
status<- unique(status)
index_norm <- left_join(index_norm, status, by="Flower")

#add pollinator important index to table 1
#merge data frames
index_norm2 <- index_norm %>% select(c(Flower, index))
table1<- merge(x = table1, y = index_norm2, all = TRUE)

#Order by most important species (highest index)
index2 <- index_norm[order(-index_norm$index), ]
  #grouping
index2$group <- "not important"
index2$group[1:5] = "important"
  #add short names
index2$Names <- "name"
index2$Names[1:5] = c("CADU4", "HEVI4", "LUAR3", "GECA3", "CAGU")

#visualize index (ternary plot)
Fig6 <- index2 %>%
  ggtern(aes(x = concentration, y = IntTotal, z = IntRich, label=Names)) +
  geom_point(size=2, aes(fill=Status, color=Status)) +
  geom_point(data=index2[index2$group == "important",], size=4, shape=18,
             aes(color=Status)) +
  annotate(geom = 'text',
           x = c(0.228, 0.483, 0.145, 0.114, 0.161),
           y = c(1, 0.372, 0.754, 0.611, 0.309),
           z = c(0.714, 0.642, 1, 0.893, 0.714),
           angle = c(0, 0, 0, 0, 0),
           vjust = c(0, 0, 0, 1, 0),
           hjust = c(1, 1, 1, 1, 1),
           label = paste(c("CADU4", "LUAR3", "HEVI4", "GECA3", "CAGU"))) +
  labs(x= "", 
       xarrow= "Protein concentration", 
       y = "", 
       yarrow = "Interaction abundance", 
       z="", 
       zarrow="Interaction richness")+
  theme_latex(TRUE) + 
  theme_bw() +
theme_arrownormal() + 
 scale_colour_manual(values=cbPalette) 

ggsave("Fig6_800.tiff", width = 13, height = 5, device='tiff', dpi=800)

#pollinator importance index distribution
ggplot(index2, aes(x=index)) + geom_density()


```

# Create model

```{r}
# Table 2

#calculate total interactions

vars_I <- Bees3 %>% group_by(Site, Day, Sample, Flower, Bee) %>% summarize(IntTotal = length(unique(ID)))

#calculate unique interactions

vars_I <- vars_I %>% group_by(Site, Day, Sample) %>% summarize(IntTotal = sum(IntTotal), IntRich = n())

#add missing values

df1 <- data.frame(Site=c('5', '7', '8'),
                  Day=c(255, 255, 255),
                  Sample=c(9, 9, 9),
                  IntTotal=c(0, 0, 0),
                  IntRich=c(0, 0, 0))

vars_I <- rbind(vars_I, df1)

#add floral density and richness
F_density <- subset(Abundance, Species != "None") 

F_density <- F_density %>% group_by(Site, Sample) %>% 
  summarize(FloralDensity = sum(Count)/75, FloralRichness = length(unique(Species)))

vars_I <- merge(x = vars_I, y = F_density, by=c("Site","Sample"), all = TRUE)

#add protein meadow density and meadow size
  #change day to sample number
P_density<- MeadowProtein
P_density$Day <- rep_len(1:9, length.out=72)
P_density<- P_density %>% rename(Sample=Day)

vars_I <- merge(x = vars_I, y = P_density, by=c("Site","Sample"), all = TRUE)

#model
m8 <- lmer(IntTotal ~ FloralDensity + FloralRichness + ProteinDensitySum2 + Size + (1|Sample), 
            data=vars_I)

summary(m8)

##

m9 <- lmer(IntRich ~ FloralDensity + FloralRichness + ProteinDensitySum2 + Size + (1|Sample), 
            data=vars_I)

summary(m9)

#Visualize significant relationships

fig7a<- ggscatter(vars_I,x="ProteinDensitySum2",y="IntTotal",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Interaction abundance")+
  xlab(expression(Log~site~protein~density~(ug/m^2)))+
  theme(legend.title = element_blank())

fig7b<- ggscatter(vars_I,x="FloralRichness",y="IntRich",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Interaction richness")+
  xlab("Floral richness")+
  theme(legend.title = element_blank())

#combine all into one figure 

fig7<- ggarrange(fig7a, fig7b,
                    labels = "auto",
                    ncol = 1, nrow = 2, common.legend=TRUE,legend="bottom")

ggsave("Fig7_800.tiff", width = 6, height = 8, device='tiff', dpi=800)

```

# Floral visual traits

Preparing data set: 
```{r}
# calculate interactions by site-sample
flowerI2 <- Bees3 %>% group_by(Flower, Bee, Site, Sample) %>% summarize(IntTotal = length(unique(ID)))

flowerI2 <- flowerI2 %>% group_by(Flower, Site, Sample) %>% summarize(IntTotal = sum(IntTotal), IntRich = n())

#Add spatial temporal data (floral abundance/relative abundance)
AbunSum3 <- Abundance %>% group_by(Site, Sample, Species) %>% 
  summarize(Count = sum(Count))
AbunSum3 <- AbunSum3 %>%
  mutate(Density=Count/75)
AbunSum3 <- rename(AbunSum3, Flower = Species)
AbunSum3<-subset(AbunSum3, Flower != "None") 

#calculating relative abundance
TotalAb<-AbunSum3 %>% group_by(Sample,Site)%>%
  summarise(Total=sum(Count))
AbunSum3 <- left_join(AbunSum3, TotalAb, by=c("Sample","Site"))
AbunSum3 <- AbunSum3 %>% mutate(Relative=(Count/Total))
  #replace NA with 0
  AbunSum3[is.na(AbunSum3)] <- 0
  
F_vars <- merge(flowerI2, AbunSum3, by=c("Site","Sample","Flower"), all=TRUE)
F_vars[is.na(F_vars)] <- 0

#Calculate means for floral traits
FloralTraits1 <- FloralTraits %>% 
  group_by(Species, UV, Color, Status) %>%
  summarise(Height=mean(Height), Size=mean(Size), Red=mean(Red), Blue=mean(Blue), Green=mean(Green))

#Add floral traits to interaction data
FloralTraits1 <- rename(FloralTraits1, Flower = Species)
F_vars <- left_join(F_vars, FloralTraits1, by="Flower")

#Add protein to bee data
Protein1 <- rename(Protein, Flower = Species)
F_vars <- left_join(F_vars, Protein1, by="Flower")

#add floral richness to data
Floralrich3<-subset(Abundance, Species != "None") 
Floralrich3<- Floralrich3 %>% group_by(Site, Sample) %>%
  summarize(Floralrich = length(unique(Species)))
F_vars <- left_join(F_vars, Floralrich3, by=c("Site","Sample"))

```

Q: Do bees visit flowers based on nutritional value, visual attraction, or availability/abundance?
  - Create a model of interaction abundance and richness with difference values of visual traits, nutritional value, and floral availability.

```{r}

#Table 3

#model total interactions
drivers<- lmer(IntTotal~Color+Status+Size+Height+UV+
               Concentration_Mean+
               Density+Relative+(1|Sample)+(1|Site),
             data=F_vars)
summary(drivers)


#model unique interactions
drivers2<- lmer(IntRich~Color+Status+Size+Height+UV+
               Concentration_Mean+
               Density+Relative+(1|Sample)+(1|Site),
             data=F_vars)
summary(drivers2)

#summarize variables
color<-F_vars %>%
  group_by(Color) %>%
  summarise(IntTotal=mean(IntTotal),
            IntRich=mean(IntRich))
status<-F_vars %>%
  group_by(Status) %>%
  summarise(IntTotal=mean(IntTotal),
            IntRich=mean(IntRich))
UV<-F_vars %>%
  group_by(UV) %>%
  summarise(IntTotal=mean(IntTotal),
            IntRich=mean(IntRich))

#supplemental graphs
#floral color
S6a<- ggplot(F_vars, aes(x = Color, y = IntTotal, fill = Color)) +
  geom_boxplot(aes(fill=Color))+ scale_fill_grey(start = .5, end = .9)+
  xlab("Flower Color") +
  ylim(0,130)+
  ylab("Interaction Abundance") +
  theme_classic()
S6b<- ggplot(F_vars, aes(x = Color, y = IntRich, fill = Color)) +
  geom_boxplot(aes(fill=Color))+ scale_fill_grey(start = .5, end = .9)+
  xlab("Flower Color") +
  ylim(0,20)+
  ylab("Interaction Richness") +
  theme_classic()
S6<- ggarrange(S6a,S6b,
               labels = "auto",
               ncol = 1, nrow = 2, common.legend=TRUE,legend="right")
```
# Floral status versus network connectance

```{r}
#format data
Interactions<- Bees3 %>% 
  group_by(Site, Flower, Bee) %>% 
  summarize(Count = length(unique(ID)))
Interactions<- as.data.frame(Interactions) #convert to df

#calculate c scores
connectance <- sapply(frame2webs(Interactions,varnames=c("Flower","Bee","Site", "Count"),type.out="list"), networklevel, index=c("connectance", "C score"))
  #reformat
connectance <- connectance[-c(2,3), ]
connectance <- as.data.frame(connectance)
connectance$Site <- row.names(connectance) 

#calculate percent invasive
Invasive <- F_vars %>% group_by(Site, Status) %>%
  summarize(Count=sum(Count))
Invasive2 <- spread(Invasive,
                        key = Status,
                        value = Count)

Invasive3 <- Invasive2 %>%
  summarize(Invasive=Introduced/(Introduced+Native))

#merge data
con_inv <- merge(connectance, Invasive3, by="Site")

#Plot
ggscatter(con_inv,x="Invasive",y="connectance",
                   palette=("#E69F00"),
              add="reg.line",
              conf.int =TRUE)+
  ylab("Network connectance")+
  xlab("% Invasive")+
  theme(legend.title = element_blank())+
  stat_cor(method = "pearson", label.x = 0, label.y = .11)  # Add correlation coefficient

```



# Bee functional traits

The following analyses examine bee functional traits across different meadows and floral protein availability. These analyses use body size (small, medium, large), sociality (social, soliatry, klepto, multiple), and nesting behavior (above ground, below ground, klepto, both). 

```{r}

# Calculate body size ratio
  #total interactions
vars_I2 <- Bees3 %>% 
  group_by(Site, Day, Sample, Flower, Bee, BodySize) %>% 
  summarize(IntTotal = length(unique(ID)))

vars_I2 <- vars_I2 %>%
  spread(key = BodySize, value = IntTotal)
    
vars_I2 <- vars_I2 %>%
  mutate_all(funs(ifelse(is.na(.), 0, .))) #change NA cells to 0

vars_I2 <- vars_I2 %>% 
  group_by(Site, Day, Sample) %>% 
  summarize(large = sum(large), 
             mid = sum(mid),
             small = sum(small))

vars_I2 <- vars_I2 %>% 
  group_by(Site, Day, Sample) %>% 
  summarize(IntTotal = sum(large+mid+small), 
            Ratio=(large/(small+mid)))

#change infinity values (to same as IntTotal)

vars_I2$Ratio[is.infinite(vars_I2$Ratio)] <- c(135,104,107,7)

#add missing values

df2 <- data.frame(Site=c('5', '7', '8'),
                  Day=c(255, 255, 255),
                  Sample=c(9, 9, 9),
                  IntTotal=c(0, 0, 0),
                  Ratio=c(0, 0, 0))

vars_I2 <- rbind(vars_I2, df2)

#add floral density and richness
F_density <- subset(Abundance, Species != "None") 

F_density <- F_density %>% group_by(Site, Sample) %>% 
  summarize(FloralDensity = sum(Count)/75, FloralRichness = length(unique(Species)))

vars_I2 <- left_join(vars_I2, F_density, by=c("Site","Sample"))

#add protein meadow density and meadow size
  #change day to sample number
P_density<- MeadowProtein
P_density$Day <- rep_len(1:9, length.out=72)
P_density<- P_density %>% rename(Sample=Day)

vars_I2 <- left_join(vars_I2, P_density, by=c("Site","Sample"))

#model: relationship between meadow size and body size ratio over time

m10<-lm(Ratio~Size*Sample, data=vars_I2)
anova(m10)


```


# Phenological mismatch

First, we need to prepare the data so that it is in the correct format. 

```{r}
###DATA PREPARATION###

##Floral Protein
#Calculate summary data for floral abundance (average count/m^2) for each species at each sampling interval 
F_AbSum <- Abundance %>% group_by(Site, Day, Species) %>% 
  summarize(Count = sum(Count))
F_AbSum <- F_AbSum %>%
  mutate(Density=Count/75)

#Floral protein data with only Species and FlowerProtein_Mean (ug protein/flower)
Protein2<- Protein %>% 
  select(c("Species", "FlowerProtein_Mean"))

#make list of data
data_list <- list(F_AbSum, Protein2)     
#merge data
MeadowProtein<-data_list %>% reduce(inner_join, by = "Species")  

#Calculate protein content density at each meadow 

#protein density per floral species
MeadowProtein <- MeadowProtein %>% 
  group_by(Site, Day, Species) %>% 
  summarize(ProteinDensity = Density*FlowerProtein_Mean)

#summarized (total protein density-sum across all species)
MeadowProtein <- MeadowProtein %>% 
  group_by(Site, Day) %>% 
  summarize(ProteinDensitySum = sum(ProteinDensity))

##Bee (/bee-flower interaction) abundances
  #Remove "None"
  BeeAb<-subset(Bees, Bee!="None")
  #Calculate summary data for bee abundance at each site and sample time 
  B_AbSum <- BeeAb %>% group_by(Site, Day) %>% 
    summarize(Abundance = length(unique(ID)))
  #Add rows for missing data
  miss<- data.frame(Site=c(5, 7, 8),
                  Day=c(255, 255, 255),
                  Abundance=c(0, 0, 0))
  B_AbSum<- merge(x = B_AbSum, y = miss, all = TRUE)

##Merge and subset by site 
  #make list of data
  data_list <- list(MeadowProtein, B_AbSum)     
  #merge data
  BeeProteinSum<-data_list %>% reduce(inner_join, by = c("Site","Day"))
  
##Calculate protein and bee abundances as ACCUMULATIONS 
  #calculate totals
 Totals<- BeeProteinSum %>%
  group_by(Site) %>%
  summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
BeeProteinSum_edit <- merge(BeeProteinSum, Totals, by="Site")
  
  #add cumulative sums
BeeProteinSum_edit <- BeeProteinSum_edit %>% 
  group_by(Site) %>%
  mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
BeeProteinSum_edit <- BeeProteinSum_edit %>% 
  mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
  
```

Create logistic regression models using the `nplr` package.

https://cran.r-project.org/web/packages/nplr/vignettes/nplr.pdf

```{r, warning = FALSE}

##Split data by site 
siteList <- split(BeeProteinSum_edit, BeeProteinSum_edit$Site) #split by site

## Create Models
Model_Protein <- lapply(siteList, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })

Model_Bee <- lapply(siteList, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })


## Visualization (S6)
tiff(file = "Site1.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site1<- overlay(c(Model_Protein$`1`,Model_Bee$`1`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site2.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site2<- overlay(c(Model_Protein$`2`,Model_Bee$`2`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site3.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site3<- overlay(c(Model_Protein$`3`,Model_Bee$`3`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site4.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site4<- overlay(c(Model_Protein$`4`,Model_Bee$`4`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site5.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site5<- overlay(c(Model_Protein$`5`,Model_Bee$`5`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site6.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site6<- overlay(c(Model_Protein$`6`,Model_Bee$`6`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site7.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site7<- overlay(c(Model_Protein$`7`,Model_Bee$`7`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

tiff(file = "Site8.tiff", width = 5600, height = 5600, units = "px", res = 800)

Site8<- overlay(c(Model_Protein$`8`,Model_Bee$`8`), showLegend=FALSE, xlab = "Day", ylab = "Accumulation", Cols=c("#E69F00", "#009E73"),cex.main=1.5, lwd = 6,
                xlim = c(140, 256),
                ylim = c(0, 1))

```


## Determining phenological mismatches

50%
```{r}
#Site1
P1_50<-getEstimates(Model_Protein$`1`, .5)
B1_50<-getEstimates(Model_Bee$`1`, .5)
#Site2
P2_50<-getEstimates(Model_Protein$`2`, .5)
B2_50<-getEstimates(Model_Bee$`2`, .5)
#Site3
P3_50<-getEstimates(Model_Protein$`3`, .5)
B3_50<-getEstimates(Model_Bee$`3`, .5)
#Site4
P4_50<-getEstimates(Model_Protein$`4`, .5)
B4_50<-getEstimates(Model_Bee$`4`, .5)
#Site5
P5_50<-getEstimates(Model_Protein$`5`, .5)
B5_50<-getEstimates(Model_Bee$`5`, .5)
#Site6
P6_50<-getEstimates(Model_Protein$`6`, .5)
B6_50<-getEstimates(Model_Bee$`6`, .5)
#Site7
P7_50<-getEstimates(Model_Protein$`7`, .5)
B7_50<-getEstimates(Model_Bee$`7`, .5)
#Site8
P8_50<-getEstimates(Model_Protein$`8`, .5)
B8_50<-getEstimates(Model_Bee$`8`, .5)



#Subtract 50% estimates (protein-bee=mismatch)
mismatch50<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50=c((P1_50$x-B1_50$x), (P2_50$x-B2_50$x), (P3_50$x-B3_50$x), 
                      (P4_50$x-B4_50$x), (P5_50$x-B5_50$x), (P6_50$x-B6_50$x),
                      (P7_50$x-B7_50$x),(P8_50$x-B8_50$x))
)


```


33%
```{r}
#Site1
P1_33<-getEstimates(Model_Protein$`1`, .33)
B1_33<-getEstimates(Model_Bee$`1`, .33)
#Site2
P2_33<-getEstimates(Model_Protein$`2`, .33)
B2_33<-getEstimates(Model_Bee$`2`, .33)
#Site3
P3_33<-getEstimates(Model_Protein$`3`, .33)
B3_33<-getEstimates(Model_Bee$`3`, .33)
#Site4
P4_33<-getEstimates(Model_Protein$`4`, .33)
B4_33<-getEstimates(Model_Bee$`4`, .33)
#Site5
P5_33<-getEstimates(Model_Protein$`5`, .33)
B5_33<-getEstimates(Model_Bee$`5`, .33)
#Site6
P6_33<-getEstimates(Model_Protein$`6`, .33)
B6_33<-getEstimates(Model_Bee$`6`, .33)
#Site7
P7_33<-getEstimates(Model_Protein$`7`, .33)
B7_33<-getEstimates(Model_Bee$`7`, .33)
#Site8
P8_33<-getEstimates(Model_Protein$`8`, .33)
B8_33<-getEstimates(Model_Bee$`8`, .33)



#Subtract 33% estimates (protein-bee=mismatch)
mismatch33<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33=c((P1_33$x-B1_33$x), (P2_33$x-B2_33$x), (P3_33$x-B3_33$x),
                      (P4_33$x-B4_33$x), (P5_33$x-B5_33$x), (P6_33$x-B6_33$x),
                      (P7_33$x-B7_33$x),(P8_33$x-B8_33$x))
)

```


90%
```{r}
#Site1
P1_90<-getEstimates(Model_Protein$`1`, .9)
B1_90<-getEstimates(Model_Bee$`1`, .9)
#Site2
P2_90<-getEstimates(Model_Protein$`2`, .9)
B2_90<-getEstimates(Model_Bee$`2`, .9)
#Site3
P3_90<-getEstimates(Model_Protein$`3`, .9)
B3_90<-getEstimates(Model_Bee$`3`, .9)
#Site4
P4_90<-getEstimates(Model_Protein$`4`, .9)
B4_90<-getEstimates(Model_Bee$`4`, .9)
#Site5
P5_90<-getEstimates(Model_Protein$`5`, .9)
B5_90<-getEstimates(Model_Bee$`5`, .9)
#Site6
P6_90<-getEstimates(Model_Protein$`6`, .9)
B6_90<-getEstimates(Model_Bee$`6`, .9)
#Site7
P7_90<-getEstimates(Model_Protein$`7`, .9)
B7_90<-getEstimates(Model_Bee$`7`, .9)
#Site8
P8_90<-getEstimates(Model_Protein$`8`, .9)
B8_90<-getEstimates(Model_Bee$`8`, .9)



#Subtract 90% estimates (protein-bee=mismatch)
mismatch90<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90=c((P1_90$x-B1_90$x), (P2_90$x-B2_90$x), (P3_90$x-B3_90$x),
                      (P4_90$x-B4_90$x), (P5_90$x-B5_90$x), (P6_90$x-B6_90$x),
                      (P7_90$x-B7_90$x),(P8_90$x-B8_90$x))
)

```

## t-test 

```{r}
#Create data table for all mismatches
##Merge and subset by site 
  #make list of data
  data_list <- list(mismatch33, mismatch50, mismatch90)     
  #merge data
  mismatch_all<-data_list %>% reduce(inner_join, by = c("Site","Size"))  

# One-sample t-test
stat.test33 <- mismatch_all %>% t_test(Mismatch33 ~ 1, mu = 0)
stat.test50 <- mismatch_all %>% t_test(Mismatch50 ~ 1, mu = 0)
stat.test90 <- mismatch_all %>% t_test(Mismatch90 ~ 1, mu = 0)

```


##Phenological mismatch comparing body size 

```{r}
###DATA PREPARATION###

##Bee (/bee-flower interaction) abundances
  #Remove "None"
  BeeAb2<-subset(Bees, Bee!="None")
  #Calculate summary data for bee abundance at each site and sample time 
  B_AbSum2 <- BeeAb2 %>% group_by(Site, Day, BodySize) %>% 
    summarize(Abundance = length(unique(ID)))
  
  #add missing data
    miss<- data.frame(Site=c(1, 1,
                             3, 3, 3,
                             4, 4,
                             5, 5, 5, 
                             6, 6, 6, 6, 6, 6,
                             7, 7, 7, 
                             8, 8, 8, 8),
                  Day=c(254, 254,
                        144, 232, 232,
                        232, 232,
                        255, 255, 255,
                        143, 143, 233, 233, 255, 255,
                        255, 255, 255,
                        255, 255, 255, 223),
                  BodySize=c("large", "mid", 
                             "large", "small", "mid",
                             "small", "mid",
                             "large", "mid", "small",
                             "large", "mid", "small", "mid", "small", "mid",
                             "large", "mid", "small",
                             "large", "mid", "small", "small"),
                  Abundance=0)
    
  B_AbSum2<- merge(x = B_AbSum2, y = miss, all = TRUE)

##Merge and subset by body size 
  #merge data
  BeeProteinSum2 <- inner_join(MeadowProtein, B_AbSum2, by = c("Site","Day"))  
  
  #subset and save each 
  large <- subset(BeeProteinSum2, subset = BodySize == "large")
  mid<- subset(BeeProteinSum2, subset = BodySize == "mid")
  small<- subset(BeeProteinSum2, subset = BodySize == "small")
  
  ##Calculate protein and bee abundances as ACCUMULATIONS 
#LARGE
  #calculate totals
 Total_l <- large %>%
  group_by(Site) %>%
  summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
large_edit <- merge(large, Total_l, by="Site")
  
  #add cumulative sums
large_edit <- large_edit %>% 
  group_by(Site) %>%
  mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
large_edit <- large_edit %>% 
  mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
#MID
  #calculate totals
 Total_m <- mid %>%
  group_by(Site) %>%
  summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
mid_edit <- merge(mid, Total_m, by="Site")
  
  #add cumulative sums
mid_edit <- mid_edit %>% 
  group_by(Site) %>%
  mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
mid_edit <- mid_edit %>% 
  mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
#SMALL
  #calculate totals
 Total_s <- small %>%
  group_by(Site) %>%
  summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
small_edit <- merge(small, Total_s, by="Site")
  
  #add cumulative sums
small_edit <- small_edit %>% 
  group_by(Site) %>%
  mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
small_edit <- small_edit %>% 
  mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)

```

# Analyzing the data 
Create logistic regression models using the `nplr` package.

https://cran.r-project.org/web/packages/nplr/vignettes/nplr.pdf


```{r, warning=FALSE}

##Split data by site 
siteList_l <- split(large_edit, large_edit$Site) #split by site
siteList_m <- split(mid_edit, mid_edit$Site) #split by site
siteList_s <- split(small_edit, small_edit$Site) #split by site

## Create Models
  #large
Model_Protein_l <- lapply(siteList_l, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_l <- lapply(siteList_l, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })
  #mid
Model_Protein_m <- lapply(siteList_m, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_m <- lapply(siteList_m, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })
  #small
Model_Protein_s <- lapply(siteList_s, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_s <- lapply(siteList_s, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })

```

#visualize data

```{r}
#merge data back together (since we want to visualize the general trend not separated by site)
large2 <- rename(large_edit, BeeAcc_l=BeeAcc)
large2 <- large2 %>% select(c(Site, Day, ProteinAcc, BeeAcc_l))
mid2 <- rename(mid_edit, BeeAcc_m=BeeAcc)
mid2 <- mid2 %>% select(c(Site, Day, BeeAcc_m))
small2 <- rename(small_edit, BeeAcc_s=BeeAcc)
small2 <- small2 %>% select(c(Site, Day, BeeAcc_s))

acc<- left_join(large2, mid2, by=c("Site", "Day"))
acc<- left_join(acc, small2, by=c("Site", "Day"))
acc <- acc %>% pivot_longer(c(ProteinAcc, BeeAcc_l, BeeAcc_m, BeeAcc_s), names_to = "Trend", values_to = "acc")

#plot
Fig4A<- ggplot(acc, aes(x = Day, y = acc, color = Trend, linetype = Trend)) +
  stat_smooth(aes(fill= Trend), method="glm", se=TRUE, fill = "grey50", size = 1.5, alpha = .1,
                  method.args = list(family=binomial)) +
  ylab("Accumulation (%)") +
  scale_linetype_manual(labels = c('Large', 'Mid-sized', 'Small','Site Protein'), values=c(1, 1, 1, 4)) +
  scale_colour_manual(labels = c('Large', 'Mid-sized', 'Small','Site Protein'), values=c("#999999", "#E69F00", "#56B4E9", "#000000")) +
  theme_classic()

```

##Phenological mismatch comparing sociality

```{r}
###DATA PREPARATION###
#Create blank data frame  
  df <- data.frame(ID = 1:288)
  newcol <- c(1:8)
  newcol2 <- c(145, 154, 167, 180, 197, 208, 224, 232, 254,
               145, 154, 167, 180, 197, 208, 224, 232, 254,
               144, 155, 168, 179, 196, 207, 224, 232, 254,
               144, 155, 168, 179, 196, 207, 224, 232, 254,
               143, 153, 171, 181, 194, 209, 223, 233, 255,
               143, 153, 171, 182, 194, 209, 223, 233, 255,
               141, 153, 169, 181, 195, 210, 223, 233, 255,
               141, 153, 169, 181, 195, 210, 223, 233, 255)
  newcol3 <- c("klepto", "multiple", "social", "solitary")
  #insert new columns by repeating each element in vector the required number of times
  df2 <- dplyr::mutate(df, Site = rep(newcol, each = 36),
                     Day = rep(newcol2, each = 4),
                     Sociality = rep(newcol3, times = 72))
  df2<- df2[,-1]
  
##Bee (/bee-flower interaction) abundances
  #Remove "None"
  BeeAb2<-subset(Bees, Bee!="None")
  #Calculate summary data for bee abundance at each site and sample time 
  B_AbSum_Soc <- BeeAb2 %>% group_by(Site, Day, Sociality) %>% 
    summarize(Abundance = length(unique(ID)))
#merge dataframes and add zeros
  B_AbSum_Soc <- merge(B_AbSum_Soc, df2, by=c("Site", "Day", "Sociality"), all.y = TRUE)
  B_AbSum_Soc[is.na(B_AbSum_Soc)] <- 0

##Merge and subset by sociality
  #merge data
  SocProtein <- merge(MeadowProtein, B_AbSum_Soc, by = c("Site","Day"), all.y=TRUE)  
  
  #subset and save each 
  klepto <- subset(SocProtein, subset = Sociality == "klepto")
  multiple<- subset(SocProtein, subset = Sociality == "multiple")
  social<- subset(SocProtein, subset = Sociality == "social")
  solitary<- subset(SocProtein, subset = Sociality == "solitary")
  
##Calculate protein and bee abundances as ACCUMULATIONS 
  #KLEPTO
   #calculate totals
   Total_kle <- klepto %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  klepto_edit <- merge(klepto, Total_kle, by="Site")
  
  #add cumulative sums
  klepto_edit <- klepto_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  klepto_edit <- klepto_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
  #Since klepto bees are rare we will remove sites where no klepto bees were found
  klepto_edit <- klepto_edit %>% drop_na()
  
  #MULTIPLE
   #calculate totals
   Total_mul <- multiple %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  mul_edit <- merge(multiple, Total_mul, by="Site")
  
  #add cumulative sums
  mul_edit <- mul_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  mul_edit <- mul_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
  
  #SOCIAL
   #calculate totals
   Total_soc <- social %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  soc_edit <- merge(social, Total_soc, by="Site")
  
  #add cumulative sums
  soc_edit <- soc_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  soc_edit <- soc_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
  
    #SOLITARY
   #calculate totals
   Total_sol <- solitary %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  sol_edit <- merge(solitary, Total_sol, by="Site")
  
  #add cumulative sums
  sol_edit <- sol_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  sol_edit <- sol_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc = cum_B/Total_B)
```
# Analyzing the data 

```{r, warning=FALSE}

##Split data by site 
siteList_1 <- split(klepto_edit, klepto_edit$Site, drop=TRUE) 
siteList_2 <- split(mul_edit, mul_edit$Site) 
siteList_3 <- split(soc_edit, soc_edit$Site) 
siteList_4 <- split(sol_edit, sol_edit$Site) 

## Create Models
  #kelpto
Model_Protein_1 <- lapply(siteList_1, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_1 <- lapply(siteList_1, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })
  #mulitple
Model_Protein_2 <- lapply(siteList_2, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_2 <- lapply(siteList_2, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })
  #social
Model_Protein_3 <- lapply(siteList_3, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_3 <- lapply(siteList_3, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })
  #soliatry
Model_Protein_4 <- lapply(siteList_4, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_4 <- lapply(siteList_4, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc, silent = TRUE, useLog=FALSE)
  })

```


#visualize data

```{r}
#merge data back together (since we want to visualize the general trend not separated by site)
klepto2 <- rename(klepto_edit, BeeAcc_1=BeeAcc)
klepto2 <- klepto2 %>% select(c(Site, Day, ProteinAcc, BeeAcc_1))
mul2 <- rename(mul_edit, BeeAcc_2=BeeAcc)
mul2 <- mul2 %>% select(c(Site, Day, ProteinAcc, BeeAcc_2))
soc2 <- rename(soc_edit, BeeAcc_3=BeeAcc)
soc2 <- soc2 %>% select(c(Site, Day, ProteinAcc, BeeAcc_3))
sol2 <- rename(sol_edit, BeeAcc_4=BeeAcc)
sol2 <- sol2 %>% select(c(Site, Day, ProteinAcc, BeeAcc_4))

acc<- left_join(mul2, klepto2, by=c("Site", "Day", "ProteinAcc"))
acc<- left_join(acc, soc2, by=c("Site", "Day", "ProteinAcc"))
acc<- left_join(acc, sol2, by=c("Site", "Day", "ProteinAcc"))
acc <- acc %>% pivot_longer(c(ProteinAcc, BeeAcc_1, BeeAcc_2, BeeAcc_3, BeeAcc_4), names_to = "Trend", values_to = "acc")
acc <- acc %>% drop_na() #remove na rows
  
#plot
Fig4B<- ggplot(acc, aes(x = Day, y = acc, color = Trend, linetype = Trend)) +
  stat_smooth(aes(fill= Trend), method="glm", se=TRUE, fill = "grey50", size = 1.5, alpha = .1,
                  method.args = list(family=binomial)) +
  ylab("Accumulation (%)") +
  scale_linetype_manual(labels = c('Klepto', 'Multiple', 'Social', 'Solitary', 'Site Protein'), values=c(1, 1, 1, 1, 4)) +
  scale_colour_manual(labels = c('Klepto', 'Multiple', 'Social', 'Solitary', 'Site Protein'), 
                      values=c("#999999", "#E69F00", "#56B4E9", "#009E73", "#000000")) +
  theme_classic()

```

##Phenological mismatch comparing nesting habitat

```{r}
###DATA PREPARATION###
#Create blank data frame  
  df <- data.frame(ID = 1:288)
  newcol <- c(1:8)
  newcol2 <- c(145, 154, 167, 180, 197, 208, 224, 232, 254,
               145, 154, 167, 180, 197, 208, 224, 232, 254,
               144, 155, 168, 179, 196, 207, 224, 232, 254,
               144, 155, 168, 179, 196, 207, 224, 232, 254,
               143, 153, 171, 181, 194, 209, 223, 233, 255,
               143, 153, 171, 182, 194, 209, 223, 233, 255,
               141, 153, 169, 181, 195, 210, 223, 233, 255,
               141, 153, 169, 181, 195, 210, 223, 233, 255)
  newcol3 <- c("above", "below", "both", "klepto")
  #insert new columns by repeating each element in vector the required number of times
  df2 <- dplyr::mutate(df, Site = rep(newcol, each = 36),
                     Day = rep(newcol2, each = 4),
                     Nest1 = rep(newcol3, times = 72))
  df2<- df2[,-1]
  
##Bee (/bee-flower interaction) abundances
  #Remove "None"
  BeeAb2<-subset(Bees, Bee!="None")
  #Calculate summary data for bee abundance at each site and sample time 
  B_AbSum_Nest <- BeeAb2 %>% group_by(Site, Day, Nest1) %>% 
    summarize(Abundance = length(unique(ID)))
#merge dataframes and add zeros
  B_AbSum_Nest <- merge(B_AbSum_Nest, df2, by=c("Site", "Day", "Nest1"), all.y = TRUE)
  B_AbSum_Nest[is.na(B_AbSum_Nest)] <- 0

##Merge and subset by nesting behavior
  #merge data
  NestProtein <- merge(MeadowProtein, B_AbSum_Nest, by = c("Site","Day"), all.y=TRUE)  
  
  #subset and save each 
  klepto<- subset(NestProtein, subset = Nest1 == "klepto") 
  above <- subset(NestProtein, subset = Nest1 == "above")
  below<- subset(NestProtein, subset = Nest1 == "below")
  both<- subset(NestProtein, subset = Nest1 == "both")

##Calculate protein and bee abundances as ACCUMULATIONS 
  #KLEPTO
   #calculate totals
   Total_kle <- klepto %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  klepto_edit <- merge(klepto, Total_kle, by="Site")
  
  #add cumulative sums
  klepto_edit <- klepto_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  klepto_edit <- klepto_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc_1 = cum_B/Total_B)
  #Since klepto bees are rare we will remove sites where no klepto bees were found
  klepto_edit <- klepto_edit %>% drop_na()
  
  #ABOVE
   #calculate totals
   Total_above <- above %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  above_edit <- merge(above, Total_above, by="Site")
  
  #add cumulative sums
  above_edit <- above_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  above_edit <- above_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc_2 = cum_B/Total_B)
  
  #BELOW
   #calculate totals
   Total_below <- below %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  below_edit <- merge(below, Total_below, by="Site")
  
  #add cumulative sums
  below_edit <- below_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  below_edit <- below_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc_3 = cum_B/Total_B)
  
    #BOTH
   #calculate totals
   Total_both <- both %>%
     group_by(Site) %>%
     summarise(Total_P = sum(ProteinDensitySum),
                          Total_B = sum(Abundance))
  #add totals to dataframe
  both_edit <- merge(both, Total_both, by="Site")
  
  #add cumulative sums
  both_edit <- both_edit %>% 
    group_by(Site) %>%
    mutate(cum_P = cumsum(ProteinDensitySum),
         cum_B = cumsum(Abundance))

  #calculate accumulations
  both_edit <- both_edit %>% 
    mutate(ProteinAcc = cum_P/Total_P,
         BeeAcc_4 = cum_B/Total_B)
```

#Create models
```{r, warning = FALSE}
##Split data by site 
siteList_a <- split(klepto_edit, klepto_edit$Site, drop=TRUE) 
siteList_b <- split(above_edit, above_edit$Site) 
siteList_c <- split(below_edit, below_edit$Site) 
siteList_d <- split(both_edit, both_edit$Site) 

  #kelpto
Model_Protein_a <- lapply(siteList_a, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_a <- lapply(siteList_a, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc_1, silent = TRUE, useLog=FALSE)
  })
  #above
Model_Protein_b <- lapply(siteList_b, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_b <- lapply(siteList_b, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc_2, silent = TRUE, useLog=FALSE)
  })
  #below
Model_Protein_c <- lapply(siteList_c, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_c <- lapply(siteList_c, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc_3, silent = TRUE, useLog=FALSE)
  })
  #both
Model_Protein_d <- lapply(siteList_d, function(tmp){
  nplr(tmp$Day, tmp$ProteinAcc, silent = TRUE, useLog=FALSE)
  })
Model_Bee_d <- lapply(siteList_d, function(tmp){
  nplr(tmp$Day, tmp$BeeAcc_4, silent = TRUE, useLog=FALSE)
  })

```

#visualize data

```{r}
#select only data needed
klepto2 <- klepto_edit %>% select(c(Site, Day, ProteinAcc, BeeAcc_1))
above2 <- above_edit %>% select(c(Site, Day, ProteinAcc, BeeAcc_2))
below2 <- below_edit %>% select(c(Site, Day, ProteinAcc, BeeAcc_3))
both2 <- both_edit %>% select(c(Site, Day, ProteinAcc, BeeAcc_4))

acc<- left_join(above2, klepto2, by=c("Site", "Day", "ProteinAcc"))
acc<- left_join(acc, below2, by=c("Site", "Day", "ProteinAcc"))
acc<- left_join(acc, both2, by=c("Site", "Day", "ProteinAcc"))
acc <- acc %>% pivot_longer(c(ProteinAcc, BeeAcc_1, BeeAcc_2, BeeAcc_3, BeeAcc_4), names_to = "Trend", values_to = "acc")
acc <- acc %>% drop_na() #remove na rows
  
#plot
Fig4C<- ggplot(acc, aes(x = Day, y = acc, color = Trend, linetype = Trend)) +
  stat_smooth(aes(fill= Trend), method="glm", se=TRUE, fill = "grey50", size = 1.5, alpha = .1,
                  method.args = list(family=binomial)) +
  ylab("Accumulation (%)") +
  scale_linetype_manual(labels = c('Klepto', 'Above', 'Below', 'Both', 'Site Protein'), values=c(1, 1, 1, 1, 4)) +
  scale_colour_manual(labels = c('Klepto', 'Above', 'Below', 'Both', 'Site Protein'), values=c("#999999", "#E69F00", "#56B4E9", "#009E73", "#000000")) +
  theme_classic()

fig4<-ggarrange(Fig4A, Fig4B, Fig4C,
          labels = "auto",
          ncol = 1, nrow = 3, legend="right") 

ggsave("Fig4_800.tiff", width = 9, height = 15, device='tiff', dpi=800)

```

## Determining phenological mismatches

1) BODY SIZE
  a) 33% temporal distance
```{r}
# BODY SIZE: 33% temporal distance
  #large
    #protein
    P_33_size_l <- lapply(Model_Protein_l, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_size_l <-bind_rows(P_33_size_l, .id = "Site")
    #bees
    B_33_size_l <- lapply(Model_Bee_l, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_size_l <-bind_rows(B_33_size_l, .id = "Site")
    #calculate mismatch
    mismatch33_size_l<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_l=(P_33_size_l$x-B_33_size_l$x)) #calculate mismatch
  #medium
    P_33_size_m <- lapply(Model_Protein_m, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_size_m <-bind_rows(P_33_size_m, .id = "Site")
    #bees
    B_33_size_m <- lapply(Model_Bee_m, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_size_m <-bind_rows(B_33_size_m, .id = "Site")
    #calculate mismatch
    mismatch33_size_m<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_m=(P_33_size_m$x-B_33_size_m$x)) #calculate mismatch
  #small
    P_33_size_s <- lapply(Model_Protein_s, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_size_s <-bind_rows(P_33_size_s, .id = "Site")
    #bees
    B_33_size_s <- lapply(Model_Bee_s, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_size_s <-bind_rows(B_33_size_s, .id = "Site")
    #calculate mismatch
    mismatch33_size_s<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_s=(P_33_size_s$x-B_33_size_s$x)) #calculate mismatch
    
   #combine data 
  Mismatch_size_33 <- inner_join(mismatch33_size_l, mismatch33_size_m, by = c("Site","Size"))  
  Mismatch_size_33 <- inner_join(Mismatch_size_33, mismatch33_size_s, by = c("Site","Size"))
  #rename columns
  Mismatch_size_33 <- rename(Mismatch_size_33, c(Large=Mismatch33_l, Medium=Mismatch33_m, Small=Mismatch33_s))
  #wide to long format
  Mismatch_size_33 = gather(Mismatch_size_33, Bodysize, mismatch, Large:Small, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 33% mismatch
model<- aov(Mismatch_size_33$mismatch ~ Mismatch_size_33$Bodysize )
TukeyHSD(model, conf.level=.95)

fig5a<- ggplot(Mismatch_size_33, aes(x=Bodysize, y=mismatch, fill=Bodysize)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Bodysize))+ 
  ylab("33% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  stat_summary(geom = 'text', label = c("a","b","b"), fun = max, hjust=1) + 
  scale_fill_manual(values=cbPalette)   
    

```

 b) 50% temporal distance
```{r}
# BODY SIZE: 50% temporal distance
  #large
    #protein
    P_50_size_l <- lapply(Model_Protein_l, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_size_l <-bind_rows(P_50_size_l, .id = "Site")
    #bees
    B_50_size_l <- lapply(Model_Bee_l, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_size_l <-bind_rows(B_50_size_l, .id = "Site")
    #calculate mismatch
    mismatch50_size_l<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_l=(P_50_size_l$x-B_50_size_l$x)) #calculate mismatch
  #medium
    P_50_size_m <- lapply(Model_Protein_m, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_size_m <-bind_rows(P_50_size_m, .id = "Site")
    #bees
    B_50_size_m <- lapply(Model_Bee_m, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_size_m <-bind_rows(B_50_size_m, .id = "Site")
    #calculate mismatch
    mismatch50_size_m<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_m=(P_50_size_m$x-B_50_size_m$x)) #calculate mismatch
  #small
    P_50_size_s <- lapply(Model_Protein_s, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_size_s <-bind_rows(P_50_size_s, .id = "Site")
    #bees
    B_50_size_s <- lapply(Model_Bee_s, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_size_s <-bind_rows(B_50_size_s, .id = "Site")
    #calculate mismatch
    mismatch50_size_s<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_s=(P_50_size_s$x-B_50_size_s$x)) #calculate mismatch
    
   #combine data 
  Mismatch_size_50 <- inner_join(mismatch50_size_l, mismatch50_size_m, by = c("Site","Size"))  
  Mismatch_size_50 <- inner_join(Mismatch_size_50, mismatch50_size_s, by = c("Site","Size"))
  #rename columns
  Mismatch_size_50 <- rename(Mismatch_size_50, c(Large=Mismatch50_l, Medium=Mismatch50_m, Small=Mismatch50_s))
  #wide to long format
  Mismatch_size_50 = gather(Mismatch_size_50, Bodysize, mismatch, Large:Small, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 50% mismatch
model<- aov(Mismatch_size_50$mismatch ~ Mismatch_size_50$Bodysize )
TukeyHSD(model, conf.level=.95)

fig5b<- ggplot(Mismatch_size_50, aes(x=Bodysize, y=mismatch, fill=Bodysize)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Bodysize))+ 
  ylab("50% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  stat_summary(geom = 'text', label = c("a","b","b"), fun = max, hjust=1) + 
  scale_fill_manual(values=cbPalette)   
    

```

 c) 90% temporal distance
```{r}
# BODY SIZE: 90% temporal distance
  #large
    #protein
    P_90_size_l <- lapply(Model_Protein_l, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_size_l <-bind_rows(P_90_size_l, .id = "Site")
    #bees
    B_90_size_l <- lapply(Model_Bee_l, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_size_l <-bind_rows(B_90_size_l, .id = "Site")
    #calculate mismatch
    mismatch90_size_l<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_l=(P_90_size_l$x-B_90_size_l$x)) #calculate mismatch
  #medium
    P_90_size_m <- lapply(Model_Protein_m, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_size_m <-bind_rows(P_90_size_m, .id = "Site")
    #bees
    B_90_size_m <- lapply(Model_Bee_m, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_size_m <-bind_rows(B_90_size_m, .id = "Site")
    #calculate mismatch
    mismatch90_size_m<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_m=(P_90_size_m$x-B_90_size_m$x)) #calculate mismatch
  #small
    P_90_size_s <- lapply(Model_Protein_s, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_size_s <-bind_rows(P_90_size_s, .id = "Site")
    #bees
    B_90_size_s <- lapply(Model_Bee_s, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_size_s <-bind_rows(B_90_size_s, .id = "Site")
    #calculate mismatch
    mismatch90_size_s<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_s=(P_90_size_s$x-B_90_size_s$x)) #calculate mismatch
    
   #combine data 
  Mismatch_size_90 <- inner_join(mismatch90_size_l, mismatch90_size_m, by = c("Site","Size"))  
  Mismatch_size_90 <- inner_join(Mismatch_size_90, mismatch90_size_s, by = c("Site","Size"))
  #rename columns
  Mismatch_size_90 <- rename(Mismatch_size_90, c(Large=Mismatch90_l, Medium=Mismatch90_m, Small=Mismatch90_s))
  #wide to long format
  Mismatch_size_90 = gather(Mismatch_size_90, Bodysize, mismatch, Large:Small, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 33% mismatch
model<- aov(Mismatch_size_90$mismatch ~ Mismatch_size_90$Bodysize )
TukeyHSD(model, conf.level=.95)

fig5c<- ggplot(Mismatch_size_90, aes(x=Bodysize, y=mismatch, fill=Bodysize)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Bodysize))+ 
  ylab("90% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  scale_fill_manual(values=cbPalette)   
    
#ALL BODY SIZE  
fig5_1<-ggarrange(fig5a, fig5b, fig5c,
          labels = "auto",
          ncol = 3, nrow = 1, common.legend=TRUE, legend="right") 
```

#analysis
```{r}
m11<-lm(mismatch~Bodysize, data=Mismatch_size_90)
anova(m11)

m12<-lm(mismatch~Bodysize, data=Mismatch_size_50)
anova(m12)

m13<-lm(mismatch~Bodysize, data=Mismatch_size_33)
anova(m13)
```

2) SOCIALITY
  d) 33% temporal distance
```{r}
# SOCIALITY: 33% temporal distance
  #klepto
    #protein
    P_33_soc_1 <- lapply(Model_Protein_1, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_1 <-bind_rows(P_33_soc_1, .id = "Site")
    #bees
    B_33_soc_1 <- lapply(Model_Bee_1, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_1 <-bind_rows(B_33_soc_1, .id = "Site")
    #calculate mismatch
    mismatch33_soc_1<-data.frame(Site=c(1, 2, 3, 4, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_1=(P_33_soc_1$x-B_33_soc_1$x)) #calculate mismatch
  #multiple
    P_33_soc_2 <- lapply(Model_Protein_2, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_2 <-bind_rows(P_33_soc_2, .id = "Site")
    #bees
    B_33_soc_2 <- lapply(Model_Bee_2, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_2 <-bind_rows(B_33_soc_2, .id = "Site")
    #calculate mismatch
    mismatch33_soc_2<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_2=(P_33_soc_2$x-B_33_soc_2$x)) #calculate mismatch
  #social
    P_33_soc_3 <- lapply(Model_Protein_3, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_3 <-bind_rows(P_33_soc_3, .id = "Site")
    #bees
    B_33_soc_3 <- lapply(Model_Bee_3, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_3 <-bind_rows(B_33_soc_3, .id = "Site")
    #calculate mismatch
    mismatch33_soc_3<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_3=(P_33_soc_3$x-B_33_soc_3$x)) #calculate mismatch
   #solitary
    P_33_soc_4 <- lapply(Model_Protein_4, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_4 <-bind_rows(P_33_soc_4, .id = "Site")
    #bees
    B_33_soc_4 <- lapply(Model_Bee_4, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_4 <-bind_rows(B_33_soc_4, .id = "Site")
    #calculate mismatch
    mismatch33_soc_4<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_4=(P_33_soc_4$x-B_33_soc_4$x)) #calculate mismatch
    
   #combine data 
  Mismatch_soc_33 <- inner_join(mismatch33_soc_1, mismatch33_soc_2, by = c("Site","Size"))  
  Mismatch_soc_33 <- inner_join(Mismatch_soc_33, mismatch33_soc_3, by = c("Site","Size"))
  Mismatch_soc_33 <- inner_join(Mismatch_soc_33, mismatch33_soc_4, by = c("Site","Size"))
  #rename columns
  Mismatch_soc_33 <- rename(Mismatch_soc_33, c(Klepto=Mismatch33_1, Multiple=Mismatch33_2, Social=Mismatch33_3, Solitary=Mismatch33_4))
  #wide to long format
  Mismatch_soc_33 = gather(Mismatch_soc_33, Sociality, mismatch, Klepto:Solitary, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 33% mismatch
model<- aov(Mismatch_soc_33$mismatch ~ Mismatch_soc_33$Sociality )
TukeyHSD(model, conf.level=.95)

fig5d<- ggplot(Mismatch_soc_33, aes(x=Sociality, y=mismatch, fill=Sociality)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Sociality))+ 
  ylab("33% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  stat_summary(geom = 'text', label = c("a","a","b, c","a, c"), fun = max, hjust=1, vjust=-0.3) + 
  scale_fill_manual(values=cbPalette)   
    

```

 e) 50% temporal distance
```{r}
# SOCIALITY: 50% temporal distance
  #klepto
    #protein
    P_50_soc_1 <- lapply(Model_Protein_1, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_1 <-bind_rows(P_50_soc_1, .id = "Site")
    #bees
    B_50_soc_1 <- lapply(Model_Bee_1, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_1 <-bind_rows(B_50_soc_1, .id = "Site")
    #calculate mismatch
    mismatch50_soc_1<-data.frame(Site=c(1, 2, 3, 4, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_1=(P_50_soc_1$x-B_50_soc_1$x)) #calculate mismatch
  #multiple
    P_50_soc_2 <- lapply(Model_Protein_2, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_2 <-bind_rows(P_50_soc_2, .id = "Site")
    #bees
    B_50_soc_2 <- lapply(Model_Bee_2, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_2 <-bind_rows(B_50_soc_2, .id = "Site")
    #calculate mismatch
    mismatch50_soc_2<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_2=(P_50_soc_2$x-B_50_soc_2$x)) #calculate mismatch
  #social
    P_50_soc_3 <- lapply(Model_Protein_3, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_3 <-bind_rows(P_50_soc_3, .id = "Site")
    #bees
    B_50_soc_3 <- lapply(Model_Bee_3, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_3 <-bind_rows(B_50_soc_3, .id = "Site")
    #calculate mismatch
    mismatch50_soc_3<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_3=(P_50_soc_3$x-B_50_soc_3$x)) #calculate mismatch
   #solitary
    P_50_soc_4 <- lapply(Model_Protein_4, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_4 <-bind_rows(P_50_soc_4, .id = "Site")
    #bees
    B_50_soc_4 <- lapply(Model_Bee_4, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_4 <-bind_rows(B_50_soc_4, .id = "Site")
    #calculate mismatch
    mismatch50_soc_4<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_4=(P_50_soc_4$x-B_50_soc_4$x)) #calculate mismatch
    
   #combine data 
  Mismatch_soc_50 <- inner_join(mismatch50_soc_1, mismatch50_soc_2, by = c("Site","Size"))  
  Mismatch_soc_50 <- inner_join(Mismatch_soc_50, mismatch50_soc_3, by = c("Site","Size"))
  Mismatch_soc_50 <- inner_join(Mismatch_soc_50, mismatch50_soc_4, by = c("Site","Size"))
  #rename columns
  Mismatch_soc_50 <- rename(Mismatch_soc_50, c(Klepto=Mismatch50_1, Multiple=Mismatch50_2, Social=Mismatch50_3, Solitary=Mismatch50_4))
  #wide to long format
  Mismatch_soc_50 = gather(Mismatch_soc_50, Sociality, mismatch, Klepto:Solitary, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 50% mismatch
model<- aov(Mismatch_soc_50$mismatch ~ Mismatch_soc_50$Sociality )
TukeyHSD(model, conf.level=.95)

fig5e<- ggplot(Mismatch_soc_50, aes(x=Sociality, y=mismatch, fill=Sociality)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Sociality))+ 
  ylab("50% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  stat_summary(geom = 'text', label = c("a","a","b, c","a, c"), fun = max, hjust=1, vjust=-0.3) + 
  scale_fill_manual(values=cbPalette)   
    

```

f) 90% temporal distance
```{r}
# SOCIALITY: 90% temporal distance
  #klepto
    #protein
    P_90_soc_1 <- lapply(Model_Protein_1, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_1 <-bind_rows(P_90_soc_1, .id = "Site")
    #bees
    B_90_soc_1 <- lapply(Model_Bee_1, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_1 <-bind_rows(B_90_soc_1, .id = "Site")
    #calculate mismatch
    mismatch90_soc_1<-data.frame(Site=c(1, 2, 3, 4, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_1=(P_90_soc_1$x-B_90_soc_1$x)) #calculate mismatch
  #multiple
    P_90_soc_2 <- lapply(Model_Protein_2, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_2 <-bind_rows(P_90_soc_2, .id = "Site")
    #bees
    B_90_soc_2 <- lapply(Model_Bee_2, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_2 <-bind_rows(B_90_soc_2, .id = "Site")
    #calculate mismatch
    mismatch90_soc_2<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_2=(P_90_soc_2$x-B_90_soc_2$x)) #calculate mismatch
  #social
    P_90_soc_3 <- lapply(Model_Protein_3, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_3 <-bind_rows(P_90_soc_3, .id = "Site")
    #bees
    B_90_soc_3 <- lapply(Model_Bee_3, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_3 <-bind_rows(B_90_soc_3, .id = "Site")
    #calculate mismatch
    mismatch90_soc_3<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_3=(P_90_soc_3$x-B_90_soc_3$x)) #calculate mismatch
   #solitary
    P_90_soc_4 <- lapply(Model_Protein_4, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_4 <-bind_rows(P_90_soc_4, .id = "Site")
    #bees
    B_90_soc_4 <- lapply(Model_Bee_4, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_4 <-bind_rows(B_90_soc_4, .id = "Site")
    #calculate mismatch
    mismatch90_soc_4<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_4=(P_90_soc_4$x-B_90_soc_4$x)) #calculate mismatch
    
   #combine data 
  Mismatch_soc_90 <- inner_join(mismatch90_soc_1, mismatch90_soc_2, by = c("Site","Size"))  
  Mismatch_soc_90 <- inner_join(Mismatch_soc_90, mismatch90_soc_3, by = c("Site","Size"))
  Mismatch_soc_90 <- inner_join(Mismatch_soc_90, mismatch90_soc_4, by = c("Site","Size"))
  #rename columns
  Mismatch_soc_90 <- rename(Mismatch_soc_90, c(Klepto=Mismatch90_1, Multiple=Mismatch90_2, Social=Mismatch90_3, Solitary=Mismatch90_4))
  #wide to long format
  Mismatch_soc_90 = gather(Mismatch_soc_90, Sociality, mismatch, Klepto:Solitary, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 90% mismatch
model<- aov(Mismatch_soc_90$mismatch ~ Mismatch_soc_90$Sociality )
TukeyHSD(model, conf.level=.95)

fig5f<- ggplot(Mismatch_soc_90, aes(x=Sociality, y=mismatch, fill=Sociality)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Sociality))+ 
  ylab("90% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  scale_fill_manual(values=cbPalette)   
    
#ALL SOCIALITY
fig5_2<-ggarrange(fig5d, fig5e, fig5f,
          labels = c("d","e","f"),
          ncol = 3, nrow = 1, common.legend=TRUE, legend="right") 

```

#analysis
```{r}
m14<-lm(mismatch~Sociality, data=Mismatch_soc_90)
anova(m14)

m15<-lm(mismatch~Sociality, data=Mismatch_soc_50)
anova(m15)

m16<-lm(mismatch~Sociality, data=Mismatch_soc_33)
anova(m16)
```


3) NESTING BEHAVIOR
  g) 33% temporal distance
```{r}
# NESTING: 33% temporal distance
  #klepto
    #protein
    P_33_soc_1 <- lapply(Model_Protein_a, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_1 <-bind_rows(P_33_soc_1, .id = "Site")
    #bees
    B_33_soc_1 <- lapply(Model_Bee_a, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_1 <-bind_rows(B_33_soc_1, .id = "Site")
    #calculate mismatch
    mismatch33_soc_1<-data.frame(Site=c(1, 2, 3, 4, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_1=(P_33_soc_1$x-B_33_soc_1$x)) #calculate mismatch
  #above
    P_33_soc_2 <- lapply(Model_Protein_b, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_2 <-bind_rows(P_33_soc_2, .id = "Site")
    #bees
    B_33_soc_2 <- lapply(Model_Bee_b, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_2 <-bind_rows(B_33_soc_2, .id = "Site")
    #calculate mismatch
    mismatch33_soc_2<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_2=(P_33_soc_2$x-B_33_soc_2$x)) #calculate mismatch
  #below
    P_33_soc_3 <- lapply(Model_Protein_c, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_3 <-bind_rows(P_33_soc_3, .id = "Site")
    #bees
    B_33_soc_3 <- lapply(Model_Bee_c, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_3 <-bind_rows(B_33_soc_3, .id = "Site")
    #calculate mismatch
    mismatch33_soc_3<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_3=(P_33_soc_3$x-B_33_soc_3$x)) #calculate mismatch
   #both
    P_33_soc_4 <- lapply(Model_Protein_d, function(x){
      getEstimates(x, .33)}) #estimates from protein model
    P_33_soc_4 <-bind_rows(P_33_soc_4, .id = "Site")
    #bees
    B_33_soc_4 <- lapply(Model_Bee_d, function(x){
     getEstimates(x, .33)}) #estimated from bee model
    B_33_soc_4 <-bind_rows(B_33_soc_4, .id = "Site")
    #calculate mismatch
    mismatch33_soc_4<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch33_4=(P_33_soc_4$x-B_33_soc_4$x)) #calculate mismatch
    
   #combine data 
  Mismatch_soc_33 <- inner_join(mismatch33_soc_1, mismatch33_soc_2, by = c("Site","Size"))  
  Mismatch_soc_33 <- inner_join(Mismatch_soc_33, mismatch33_soc_3, by = c("Site","Size"))
  Mismatch_soc_33 <- inner_join(Mismatch_soc_33, mismatch33_soc_4, by = c("Site","Size"))
  #rename columns
  Mismatch_soc_33 <- rename(Mismatch_soc_33, c(Klepto=Mismatch33_1, Above=Mismatch33_2, Below=Mismatch33_3, Both=Mismatch33_4))
  #wide to long format
  Mismatch_soc_33 = gather(Mismatch_soc_33, Nesting, mismatch, Klepto:Both, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 33% mismatch
model<- aov(Mismatch_soc_33$mismatch ~ Mismatch_soc_33$Nesting )
TukeyHSD(model, conf.level=.95)

fig5g<- ggplot(Mismatch_soc_33, aes(x=Nesting, y=mismatch, fill=Nesting)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Nesting))+ 
  ylab("33% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  stat_summary(geom = 'text', label = c("a","a, c","b, c","b, c"), fun = max, hjust=1, vjust=-0.3) + 
  scale_fill_manual(values=cbPalette)   
    

```
h) 50% temporal distance
```{r}
# NESTING BEHAVIOR: 50% temporal distance
  #klepto
    #protein
    P_50_soc_1 <- lapply(Model_Protein_a, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_1 <-bind_rows(P_50_soc_1, .id = "Site")
    #bees
    B_50_soc_1 <- lapply(Model_Bee_a, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_1 <-bind_rows(B_50_soc_1, .id = "Site")
    #calculate mismatch
    mismatch50_soc_1<-data.frame(Site=c(1, 2, 3, 4, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_1=(P_50_soc_1$x-B_50_soc_1$x)) #calculate mismatch
  #above
    P_50_soc_2 <- lapply(Model_Protein_b, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_2 <-bind_rows(P_50_soc_2, .id = "Site")
    #bees
    B_50_soc_2 <- lapply(Model_Bee_b, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_2 <-bind_rows(B_50_soc_2, .id = "Site")
    #calculate mismatch
    mismatch50_soc_2<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_2=(P_50_soc_2$x-B_50_soc_2$x)) #calculate mismatch
  #below
    P_50_soc_3 <- lapply(Model_Protein_c, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_3 <-bind_rows(P_50_soc_3, .id = "Site")
    #bees
    B_50_soc_3 <- lapply(Model_Bee_c, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_3 <-bind_rows(B_50_soc_3, .id = "Site")
    #calculate mismatch
    mismatch50_soc_3<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_3=(P_50_soc_3$x-B_50_soc_3$x)) #calculate mismatch
   #both
    P_50_soc_4 <- lapply(Model_Protein_d, function(x){
      getEstimates(x, .5)}) #estimates from protein model
    P_50_soc_4 <-bind_rows(P_50_soc_4, .id = "Site")
    #bees
    B_50_soc_4 <- lapply(Model_Bee_d, function(x){
     getEstimates(x, .5)}) #estimated from bee model
    B_50_soc_4 <-bind_rows(B_50_soc_4, .id = "Site")
    #calculate mismatch
    mismatch50_soc_4<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch50_4=(P_50_soc_4$x-B_50_soc_4$x)) #calculate mismatch
    
   #combine data 
  Mismatch_soc_50 <- inner_join(mismatch50_soc_1, mismatch50_soc_2, by = c("Site","Size"))  
  Mismatch_soc_50 <- inner_join(Mismatch_soc_50, mismatch50_soc_3, by = c("Site","Size"))
  Mismatch_soc_50 <- inner_join(Mismatch_soc_50, mismatch50_soc_4, by = c("Site","Size"))
  #rename columns
  Mismatch_soc_50 <- rename(Mismatch_soc_50, c(Klepto=Mismatch50_1, Above=Mismatch50_2, Below=Mismatch50_3, Both=Mismatch50_4))
  #wide to long format
  Mismatch_soc_50 = gather(Mismatch_soc_50, Nesting, mismatch, Klepto:Both, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 50% mismatch
model<- aov(Mismatch_soc_50$mismatch ~ Mismatch_soc_50$Nesting )
TukeyHSD(model, conf.level=.95)

fig5h<- ggplot(Mismatch_soc_50, aes(x=Nesting, y=mismatch, fill=Nesting)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Nesting))+ 
  ylab("50% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  stat_summary(geom = 'text', label = c("a","a, c","b, c","a, c"), fun = max, hjust=1, vjust=-0.3) + 
  scale_fill_manual(values=cbPalette)   
    

```

i) 90% temporal distance
```{r}
# NESTING BEHAVIOR: 90% temporal distance
  #klepto
    #protein
    P_90_soc_1 <- lapply(Model_Protein_a, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_1 <-bind_rows(P_90_soc_1, .id = "Site")
    #bees
    B_90_soc_1 <- lapply(Model_Bee_a, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_1 <-bind_rows(B_90_soc_1, .id = "Site")
    #calculate mismatch
    mismatch90_soc_1<-data.frame(Site=c(1, 2, 3, 4, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_1=(P_90_soc_1$x-B_90_soc_1$x)) #calculate mismatch
  #above
    P_90_soc_2 <- lapply(Model_Protein_b, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_2 <-bind_rows(P_90_soc_2, .id = "Site")
    #bees
    B_90_soc_2 <- lapply(Model_Bee_b, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_2 <-bind_rows(B_90_soc_2, .id = "Site")
    #calculate mismatch
    mismatch90_soc_2<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_2=(P_90_soc_2$x-B_90_soc_2$x)) #calculate mismatch
  #below
    P_90_soc_3 <- lapply(Model_Protein_c, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_3 <-bind_rows(P_90_soc_3, .id = "Site")
    #bees
    B_90_soc_3 <- lapply(Model_Bee_c, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_3 <-bind_rows(B_90_soc_3, .id = "Site")
    #calculate mismatch
    mismatch90_soc_3<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_3=(P_90_soc_3$x-B_90_soc_3$x)) #calculate mismatch
   #both
    P_90_soc_4 <- lapply(Model_Protein_d, function(x){
      getEstimates(x, .9)}) #estimates from protein model
    P_90_soc_4 <-bind_rows(P_90_soc_4, .id = "Site")
    #bees
    B_90_soc_4 <- lapply(Model_Bee_d, function(x){
     getEstimates(x, .9)}) #estimated from bee model
    B_90_soc_4 <-bind_rows(B_90_soc_4, .id = "Site")
    #calculate mismatch
    mismatch90_soc_4<-data.frame(Site=c(1, 2, 3, 4, 5, 6, 7, 8), #site numbers
           Size=c(0.44, 0.55, 2.96, 1, 0.83, 0.79, 0.45, 0.16), #size of site (ha), extracted from "SiteInformation file"
           Mismatch90_4=(P_90_soc_4$x-B_90_soc_4$x)) #calculate mismatch
    
   #combine data 
  Mismatch_soc_90 <- inner_join(mismatch90_soc_1, mismatch90_soc_2, by = c("Site","Size"))  
  Mismatch_soc_90 <- inner_join(Mismatch_soc_90, mismatch90_soc_3, by = c("Site","Size"))
  Mismatch_soc_90 <- inner_join(Mismatch_soc_90, mismatch90_soc_4, by = c("Site","Size"))
  #rename columns
  Mismatch_soc_90 <- rename(Mismatch_soc_90, c(Klepto=Mismatch90_1, Above=Mismatch90_2, Below=Mismatch90_3, Both=Mismatch90_4))
  #wide to long format
  Mismatch_soc_90 = gather(Mismatch_soc_90, Nesting, mismatch, Klepto:Both, factor_key=TRUE)

# box plot with ANOVA tests/Tukey HSD
# 90% mismatch
model<- aov(Mismatch_soc_90$mismatch ~ Mismatch_soc_90$Nesting )
TukeyHSD(model, conf.level=.95)

fig5i<- ggplot(Mismatch_soc_90, aes(x=Nesting, y=mismatch, fill=Nesting)) +
  geom_boxplot(outlier.shape = NA, aes(fill=Nesting))+ 
  ylab("90% Temporal distance (days)")+
   xlab(element_blank())+
  geom_hline(yintercept = 0, linetype=2) +
  theme(axis.text.x=element_blank(),
      axis.ticks.x=element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "black"))+  
  scale_fill_manual(values=cbPalette)   
    
#ALL SOCIALITY
fig5_3<-ggarrange(fig5g, fig5h, fig5i,
          labels = c("g","h","i"),
          ncol = 3, nrow = 1, common.legend=TRUE, legend="right") 

#FIGURE 5
fig5<-ggarrange(fig5_1, fig5_2, fig5_3,
          ncol = 1, nrow = 3) 

ggsave("Fig5_800.tiff", width = 10, height = 10, device='tiff', dpi=800)

```

#analysis
```{r}
m17<-lm(mismatch~Nesting, data=Mismatch_soc_90)
anova(m17)

m18<-lm(mismatch~Nesting, data=Mismatch_soc_50)
anova(m18)

m19<-lm(mismatch~Nesting, data=Mismatch_soc_33)
anova(m19)
```
